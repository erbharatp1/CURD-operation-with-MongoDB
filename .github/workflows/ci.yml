name: CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Run Spotless Check
      run: ./mvnw spotless:check
    - name: Build and Test with Coverage
      run: ./mvnw -B verify jacoco:report
    - name: Verify Coverage
      run: |
        COVERAGE=$(grep -o "instructions covered ratio is [0-9.]*" target/site/jacoco/index.html | awk '{print $NF*100}' || echo 0)
        echo "Coverage is $COVERAGE%"
        if (( $(echo "$COVERAGE < 100" | bc -l) )); then
          echo "Coverage is below 100%"
          # exit 1 # Uncomment to fail build if coverage < 100%
        fi
